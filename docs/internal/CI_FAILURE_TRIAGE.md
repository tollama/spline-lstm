# CI FAILURE TRIAGE (e2e-gate 실패 1차 대응 규칙)

## Standard Handoff Format

### 1) 요청/목표
- 역할: PM (CI 운영/장애 triage 오너)
- 프로젝트: `~/spline-lstm`
- 목표: `e2e-gate` CI 실패 시 **역할별 1차 대응 순서와 책임**을 즉시 실행 가능한 형태로 표준화
- 적용 범위:
  - `.github/workflows/e2e-gate.yml`
  - `quick-gate`, `e2e-path`, `regression` 잡 실패

---

### 2) 실패 유형 분류 (분류 기준 + 즉시 액션)

| 유형 코드 | 실패 유형 | 대표 신호 | 1차 액션(즉시) | 기본 담당 |
|---|---|---|---|---|
| T1 | 환경/의존성 | 패키지 설치 실패, Python/OS mismatch, 네트워크 타임아웃 | 동일 commit 1회 재시도 → 동일 증상 재현 시 lockfile/버전 핀 확인 | Coder |
| T2 | 계약 테스트 | 인터페이스/스키마/입출력 계약 위반, run_id 불일치 가드 실패 | 실패 테스트명 기준 계약 문서/코드 diff 확인, 최근 머지 범위 축소 | Architect |
| T3 | E2E 경로 | `run_e2e.sh` 또는 `smoke_test.sh` 실패, 필수 artifact 누락 | 실패 스텝 로그 + artifact 경로 존재성 즉시 검증 | Tester |
| T4 | 회귀 테스트 | 기존 통과 테스트 재실패, 성능/지표 임계치 하락 | 최근 변경(24h) 기준 회귀 의심 PR 우선 식별 | Reviewer |
| T5 | 아티팩트 무결성 | 파일 손상, 체크포인트/메타 불일치, 업로드 artifact 누락 | checksum/파일 크기/생성 순서 검증, 재생성 가능성 확인 | Coder |

판정 원칙:
1. 동일 실패가 2회 연속 재현되면 일시적 플래키가 아닌 **실패 확정**으로 전환
2. 분류 불명확 시 `T3(E2E 경로)`로 임시 분류 후 15분 내 재분류

---

### 3) 역할별 1차 담당자 매핑 (PM/Architect/Coder/Reviewer/Tester)

| 실패 유형 | PM | Architect | Coder | Reviewer | Tester |
|---|---|---|---|---|---|
| T1 환경/의존성 | 우선순위 선언/소유자 지정 | 의존성 정책 검토(필요 시) | **1차 담당** (복구 실행) | 변경 위험도 점검 | 재현 로그 보강 |
| T2 계약 테스트 | 영향 범위 공지 | **1차 담당** (계약 기준 확정) | 수정안 구현 | 회귀 위험 리뷰 | 재현 케이스 검증 |
| T3 E2E 경로 | 타임박스 관리 | 경로 설계 결함 판단 지원 | 스크립트/코드 수정 | 수정 diff 리뷰 | **1차 담당** (재현/검증) |
| T4 회귀 테스트 | 배포/머지 홀드 결정 | 구조적 원인 자문 | 핫픽스 구현 | **1차 담당** (회귀 판정/승인) | 재검증 수행 |
| T5 아티팩트 무결성 | 에스컬레이션 판단 | 생성 규약 확인 | **1차 담당** (무결성 복구) | 누락 리뷰 | 산출물 검증 |

운영 규칙:
- PM은 항상 조정자이며, 기술적 1차 조치는 표의 **1차 담당** Role이 수행
- 1차 담당 응답 SLA: 할당 후 10분 내 ACK(착수 선언)

---

### 4) 우선순위/타임박스 (P0/P1/P2)

| 우선순위 | 기준 | 초기 타임박스 | 대응 규칙 |
|---|---|---|---|
| P0 | `main/develop` 차단, 릴리즈/핫픽스 차단, 다중 잡 동시 실패 | 0~30분 | 즉시 수동 개입, 담당자 동시 호출, 머지 일시 동결 |
| P1 | 단일 잡 지속 실패(2회 이상), PR 흐름 저해 | 30~120분 | 1차 담당 중심 복구, 필요 시 범위 축소/임시 우회 |
| P2 | 플래키 의심, 비핵심 경고성 실패 | 당일(<=24h) | 모니터링 우선, 재현 데이터 축적 후 계획 수정 |

타임박스 만료 규칙:
- 타임박스 내 원인 미확정 시 `ESCALATE`로 상태 전환

---

### 5) 재시도 정책 (자동 재시도 vs 즉시 수동 개입)

#### 5.1 자동 재시도 허용
- 대상: T1(환경/의존성) 중 네트워크/레지스트리 일시 오류, T3 일부 플래키 케이스
- 횟수: 동일 SHA 기준 최대 1회
- 조건: 에러 시그니처가 비결정적(타임아웃/일시 연결 실패)

#### 5.2 즉시 수동 개입
- 대상:
  - T2 계약 테스트
  - T4 회귀 테스트
  - T5 아티팩트 무결성
  - 동일 실패 2회 연속 재현 케이스
- 규칙: 자동 재시도 금지, 로그/아티팩트 수집 후 1차 담당자 즉시 착수

#### 5.3 재시도 후 처리
- 재시도 성공: `MONITOR`로 24시간 관찰
- 재시도 실패: 우선순위 1단계 상향(P1→P0 가능)

---

### 6) 커뮤니케이션 템플릿 (요약 보고 포맷)

```text
[CI TRIAGE] e2e-gate 실패 요약
- Run/Commit: <run_id or url> / <sha>
- 실패 잡/단계: <quick-gate|e2e-path|regression> / <step>
- 실패 유형: <T1~T5>
- 우선순위: <P0|P1|P2>
- 1차 담당: <PM|Architect|Coder|Reviewer|Tester>
- 현재 판단: <원인 가설 1줄>
- 즉시 조치: <실행한 액션 1~3개>
- 필요 지원/결정: <merge hold, 리뷰 요청 등>
- 다음 체크포인트: <KST 시각>
- 상태: <RESOLVED|MONITOR|ESCALATE>
```

사용 규칙:
- 첫 보고는 실패 감지 후 10분 내 발행
- 상태 변경(RESOLVED/MONITOR/ESCALATE) 시 동일 스레드 업데이트

---

### 7) 종료 조건 (RESOLVED / MONITOR / ESCALATE)

| 상태 | 종료 조건 | 후속 액션 |
|---|---|---|
| RESOLVED | 동일 경로 CI 재실행 PASS + 핵심 artifact 검증 완료 | 원인/수정 PR 링크 기록 후 종료 |
| MONITOR | 임시 복구 또는 재시도 성공했으나 재발 가능성 존재 | 24시간 관찰, 재발 시 즉시 P1 이상으로 재오픈 |
| ESCALATE | 타임박스 초과, 원인 불명, 다수 PR 영향 | PM이 우선순위 상향 및 의사결정자 호출 |

---

### 8) 실행 체크리스트 (운영용)
- [ ] 실패 잡/스텝 및 로그 URL 확보
- [ ] T1~T5 분류 및 우선순위(P0~P2) 지정
- [ ] 1차 담당 할당 + 10분 내 ACK 확인
- [ ] 재시도 정책 적용(자동/수동) 결정
- [ ] 템플릿으로 요약 보고 전송
- [ ] 상태를 RESOLVED/MONITOR/ESCALATE 중 하나로 종료 처리
